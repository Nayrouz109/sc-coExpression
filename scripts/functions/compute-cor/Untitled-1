
import h5py
import pandas as pd
import numpy as np
from scipy.sparse import coo_matrix
from pathlib import Path
import json
import anndata as ad
import pickle



def save_to_hdf5(cor, output_dir, file_path):
    """
    Save correlation data, including edge lists and aggregated sparse matrices, to specified directories.
    
    Args:
        cor (dict): The correlation dictionary containing matrices, gene names, and data summary.
        output_dir (Path): The base output directory to save the data.
        file_path (Path): The input file path (used for naming output files).
    """
    # Create required directories
    agg_mtx_dir = output_dir / "agg-mtx"
    edge_list_raw_dir = output_dir / "edge-list-raw"
    edge_list_rnk_dir = output_dir / "edge-list-rnk"
    summary_dir = output_dir / "cor-summary"

    agg_mtx_dir.mkdir(parents=True, exist_ok=True)
    edge_list_raw_dir.mkdir(parents=True, exist_ok=True)
    edge_list_rnk_dir.mkdir(parents=True, exist_ok=True)
    summary_dir.mkdir(parents=True, exist_ok=True)

    # File names
    agg_file = agg_mtx_dir / f"{file_path.stem}_corAggSparse.h5ad"
    correlation_edge_list_file = edge_list_raw_dir / f"{file_path.stem}_corEdgeLists.pkl"
    rank_edge_list_file = edge_list_rnk_dir / f"{file_path.stem}_rnkEdgeLists.pkl"
    df_summary_file = summary_dir / f"{file_path.stem}_corSummary.csv"

    # Save aggregated matrix and gene names as an AnnData object
    aggregated_matrix = cor["aggregated_rank_normalized_matrix"]
    gene_names = cor["gene_names"]
    agg_adata = ad.AnnData(X=aggregated_matrix)
    agg_adata.var_names = gene_names
    agg_adata.write_h5ad(agg_file, compression="gzip")
    print(f"Saved aggregated matrix and gene names to {agg_file}")

    # Save raw edge list as JSON
    with open(correlation_edge_list_file, 'wb') as f:
        pickle.dump(cor["corEdgeList_per_patientID"], f)
    print(f"Saved raw edge list to {correlation_edge_list_file}")
    
    with open(rank_edge_list_file, 'wb') as f:
        pickle.dump(cor["rnkEdgeList_per_patientID"], f)
    print(f"Saved ranked edge list to {rank_edge_list_file}")

    # Save data summary as a CSV file
    cor["data_summary"].to_csv(df_summary_file, index=False)
    print(f"Saved data summary to {df_summary_file}")

    #with open(correlation_edge_list_file, 'w') as f:
        #json.dump(convert_tuple_keys(cor["corEdgeList_per_patientID"]), f, indent=4)
    # Save ranked edge list as JSON
    #with open(rank_edge_list_file, 'w') as f:
        #json.dump(convert_tuple_keys(cor["rnkEdgeList_per_patientID"]), f, indent=4)
    

